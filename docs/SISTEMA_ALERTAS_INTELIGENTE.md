# üö® Sistema de Alertas Inteligente - Arquitectura Premium

## üéØ Visi√≥n Estrat√©gica (Silicon Valley Style)

**Objetivo:** Crear un sistema de alertas jer√°rquico e inteligente que permita visibilidad contextual basada en roles, con priorizaci√≥n autom√°tica mediante IA y visualizaci√≥n premium estilo Apple.

---

## üìä Matriz de Visibilidad de Alertas

### Reglas de Negocio:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MATRIZ DE VISIBILIDAD                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  CREADOR          ‚îÇ  QUI√âN LO VE                                   ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  üëë ADMIN         ‚îÇ  ‚úÖ TODOS (Nacional)                           ‚îÇ
‚îÇ                   ‚îÇ  - Coordinadores de todas las regiones         ‚îÇ
‚îÇ                   ‚îÇ  - Gestores de todas las regiones              ‚îÇ
‚îÇ                   ‚îÇ  - Otros admins                                ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  üëî COORDINATOR   ‚îÇ  ‚úÖ Gestores de SU regi√≥n                      ‚îÇ
‚îÇ                   ‚îÇ  ‚úÖ Admin (monitoreo)                          ‚îÇ
‚îÇ                   ‚îÇ  ‚ùå Otros coordinadores                        ‚îÇ
‚îÇ                   ‚îÇ  ‚ùå Gestores de otras regiones                 ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  üë§ GESTOR        ‚îÇ  ‚úÖ Coordinador de SU regi√≥n                   ‚îÇ
‚îÇ  (Multi-regi√≥n)   ‚îÇ  ‚úÖ Gestores de SUS regiones asignadas         ‚îÇ
‚îÇ                   ‚îÇ  ‚úÖ Admin (monitoreo)                          ‚îÇ
‚îÇ                   ‚îÇ  ‚ùå Gestores de otras regiones                 ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  üë§ GESTOR        ‚îÇ  ‚úÖ Coordinador de SU regi√≥n                   ‚îÇ
‚îÇ  (Mono-regi√≥n)    ‚îÇ  ‚úÖ Admin (monitoreo)                          ‚îÇ
‚îÇ                   ‚îÇ  ‚ùå Otros gestores                             ‚îÇ
‚îÇ                   ‚îÇ  ‚ùå Otros coordinadores                        ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üèóÔ∏è Arquitectura del Sistema

### 1. Modelo de Datos Extendido

```typescript
// Prisma Schema Extension
model RegionalReport {
  id              String   @id @default(uuid())
  userId          String   // Creador de la alerta
  regionId        String?  // Regi√≥n principal
  municipalityId  String?
  category        String
  priority        Priority
  title           String
  content         String
  attachmentUrl   String?
  
  // NUEVO: Campos para sistema de alertas inteligente
  isAlert         Boolean  @default(false)  // ¬øEs una alerta?
  alertLevel      AlertLevel?               // Nivel de criticidad
  visibilityScope String   @default("AUTO") // AUTO, REGIONAL, NATIONAL, CUSTOM
  targetAudience  Json?                     // Array de roles/usuarios espec√≠ficos
  aiPriority      Float?   @default(0)      // Score de IA (0-100)
  aiTags          String[] @default([])     // Tags generados por IA
  aiSummary       String?                   // Resumen generado por IA
  expiresAt       DateTime?                 // Fecha de expiraci√≥n
  
  // Relaciones
  user            User     @relation(fields: [userId], references: [id])
  region          Region?  @relation(fields: [regionId], references: [id])
  municipality    Municipality? @relation(fields: [municipalityId], references: [id])
  alerts          Alert[]
  readBy          AlertRead[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Nuevo modelo: AlertRead (tracking de lectura)
model AlertRead {
  id              String   @id @default(uuid())
  reportId        String
  userId          String
  readAt          DateTime @default(now())
  
  report          RegionalReport @relation(fields: [reportId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
  
  @@unique([reportId, userId])
}

// Enum extendido
enum AlertLevel {
  INFO          // Informativa
  WARNING       // Advertencia
  CRITICAL      // Cr√≠tica
  EMERGENCY     // Emergencia
}
```

---

## üß† Sistema de IA para Priorizaci√≥n

### Algoritmo de Scoring Inteligente:

```typescript
interface AlertScoringFactors {
  // Factores de contenido (40%)
  keywordMatches: number;      // Palabras clave cr√≠ticas
  sentimentScore: number;      // An√°lisis de sentimiento
  urgencyIndicators: number;   // Indicadores de urgencia
  
  // Factores contextuales (30%)
  regionPriority: number;      // Prioridad de la regi√≥n
  historicalPattern: number;   // Patrones hist√≥ricos
  timeOfDay: number;           // Hora del d√≠a
  
  // Factores de usuario (20%)
  userReliability: number;     // Confiabilidad del creador
  userRole: number;            // Peso del rol
  
  // Factores de impacto (10%)
  potentialAudience: number;   // Audiencia potencial
  geographicSpread: number;    // Dispersi√≥n geogr√°fica
}

function calculateAIPriority(alert: RegionalReport): number {
  let score = 0;
  
  // 1. An√°lisis de contenido (40 puntos)
  score += analyzeKeywords(alert.title, alert.content) * 0.15;
  score += analyzeSentiment(alert.content) * 0.15;
  score += detectUrgency(alert.title, alert.content) * 0.10;
  
  // 2. Contexto (30 puntos)
  score += getRegionPriority(alert.regionId) * 0.10;
  score += analyzeHistoricalPatterns(alert.userId, alert.category) * 0.10;
  score += getTimeRelevance(new Date()) * 0.10;
  
  // 3. Usuario (20 puntos)
  score += getUserReliabilityScore(alert.userId) * 0.10;
  score += getRoleWeight(alert.user.role) * 0.10;
  
  // 4. Impacto (10 puntos)
  score += estimateAudienceSize(alert) * 0.05;
  score += calculateGeographicImpact(alert) * 0.05;
  
  return Math.min(100, Math.max(0, score));
}

// Palabras clave cr√≠ticas
const CRITICAL_KEYWORDS = [
  'emergencia', 'urgente', 'cr√≠tico', 'peligro', 'amenaza',
  'bloqueo', 'manifestaci√≥n', 'violencia', 'desastre',
  'evacuaci√≥n', 'alerta roja', 'c√≥digo rojo'
];

const WARNING_KEYWORDS = [
  'advertencia', 'precauci√≥n', 'atenci√≥n', 'cuidado',
  'riesgo', 'problema', 'incidente', 'situaci√≥n'
];

function analyzeKeywords(title: string, content: string): number {
  const text = `${title} ${content}`.toLowerCase();
  let score = 0;
  
  CRITICAL_KEYWORDS.forEach(keyword => {
    if (text.includes(keyword)) score += 15;
  });
  
  WARNING_KEYWORDS.forEach(keyword => {
    if (text.includes(keyword)) score += 8;
  });
  
  return Math.min(15, score);
}

function detectUrgency(title: string, content: string): number {
  const urgencyPatterns = [
    /inmediato/i,
    /ahora/i,
    /ya/i,
    /urgente/i,
    /prioridad alta/i,
    /lo antes posible/i
  ];
  
  const text = `${title} ${content}`;
  let matches = 0;
  
  urgencyPatterns.forEach(pattern => {
    if (pattern.test(text)) matches++;
  });
  
  return Math.min(10, matches * 3);
}

function getRoleWeight(role: string): number {
  const weights = {
    'ADMIN': 10,
    'COORDINATOR': 8,
    'USER': 5,
    'SUPPORT': 3
  };
  return weights[role] || 0;
}
```

---

## üéØ L√≥gica de Visibilidad (Filtrado Inteligente)

### Servicio de Filtrado:

```typescript
// apps/api/src/regional-reports/regional-reports.service.ts

async getAlertsForUser(userId: string): Promise<RegionalReport[]> {
  const user = await this.prisma.user.findUnique({
    where: { id: userId },
    include: {
      region: true,
      assignedRegions: true
    }
  });

  if (!user) throw new NotFoundException('Usuario no encontrado');

  // Construir filtro basado en rol
  const visibilityFilter = this.buildVisibilityFilter(user);

  // Obtener alertas con IA scoring
  const alerts = await this.prisma.regionalReport.findMany({
    where: {
      isAlert: true,
      AND: [
        visibilityFilter,
        {
          OR: [
            { expiresAt: null },
            { expiresAt: { gt: new Date() } }
          ]
        }
      ]
    },
    include: {
      user: {
        select: {
          id: true,
          fullName: true,
          role: true
        }
      },
      region: true,
      municipality: true,
      alerts: true,
      readBy: {
        where: { userId }
      }
    },
    orderBy: [
      { aiPriority: 'desc' },
      { createdAt: 'desc' }
    ]
  });

  // Marcar como le√≠das/no le√≠das
  return alerts.map(alert => ({
    ...alert,
    isRead: alert.readBy.length > 0
  }));
}

private buildVisibilityFilter(user: User): any {
  const { role, regionId, assignedRegions } = user;

  switch (role) {
    case 'ADMIN':
      // Admin ve TODAS las alertas
      return {};

    case 'COORDINATOR':
      // Coordinador ve:
      // 1. Alertas de admin (scope NATIONAL)
      // 2. Alertas de gestores de SU regi√≥n
      return {
        OR: [
          // Alertas nacionales de admin
          {
            user: { role: 'ADMIN' },
            visibilityScope: 'NATIONAL'
          },
          // Alertas de gestores de su regi√≥n
          {
            regionId: regionId,
            user: { role: { in: ['USER', 'SUPPORT'] } }
          }
        ]
      };

    case 'USER':
    case 'SUPPORT':
      const userRegionIds = assignedRegions?.map(r => r.id) || [regionId];
      
      // Gestor ve:
      // 1. Alertas de admin (scope NATIONAL)
      // 2. Alertas de su coordinador
      // 3. Alertas de gestores multi-regi√≥n que incluyan sus regiones
      return {
        OR: [
          // Alertas nacionales de admin
          {
            user: { role: 'ADMIN' },
            visibilityScope: 'NATIONAL'
          },
          // Alertas de su coordinador
          {
            regionId: regionId,
            user: { role: 'COORDINATOR' }
          },
          // Alertas de gestores multi-regi√≥n
          {
            regionId: { in: userRegionIds },
            user: { 
              role: { in: ['USER', 'SUPPORT'] },
              assignedRegions: {
                some: {
                  id: { in: userRegionIds }
                }
              }
            }
          }
        ]
      };

    default:
      return { id: 'never-match' };
  }
}
```

---

## üì± Componentes de UI Premium

### 1. Dashboard del Admin - Vista de Monitoreo Regional

```typescript
// apps/web/src/app/dashboard/page.tsx (Admin)

interface RegionalAlertsSummary {
  regionId: string;
  regionName: string;
  totalAlerts: number;
  criticalAlerts: number;
  unreadAlerts: number;
  topAlerts: Alert[];
  trend: 'up' | 'down' | 'stable';
}

// Componente: Regional Alerts Monitor
<Card className="col-span-full rounded-[3rem] border-none bg-white shadow-2xl">
  <CardHeader className="bg-gradient-to-r from-red-50 to-orange-50 p-8">
    <div className="flex items-center justify-between">
      <div>
        <Badge className="bg-red-500 text-white mb-3">
          Centro de Comando
        </Badge>
        <CardTitle className="text-3xl font-black uppercase">
          Monitoreo Regional de Alertas
        </CardTitle>
      </div>
      <div className="flex gap-3">
        <Button variant="outline" className="rounded-2xl">
          <Filter className="h-4 w-4 mr-2" />
          Filtrar
        </Button>
        <Button className="rounded-2xl bg-red-600 hover:bg-red-700">
          <Bell className="h-4 w-4 mr-2" />
          {totalUnreadAlerts} Nuevas
        </Button>
      </div>
    </div>
  </CardHeader>
  
  <CardContent className="p-8">
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {regionalSummaries.map(region => (
        <Card key={region.regionId} className="rounded-2xl border-2 hover:shadow-xl transition-all">
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between">
              <h3 className="font-black text-lg">{region.regionName}</h3>
              <Badge className={`${
                region.criticalAlerts > 0 ? 'bg-red-500' :
                region.totalAlerts > 5 ? 'bg-amber-500' : 'bg-blue-500'
              }`}>
                {region.totalAlerts}
              </Badge>
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {/* Stats */}
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-red-50 rounded-xl p-3">
                  <p className="text-xs font-bold text-red-600 uppercase">Cr√≠ticas</p>
                  <p className="text-2xl font-black text-red-700">{region.criticalAlerts}</p>
                </div>
                <div className="bg-blue-50 rounded-xl p-3">
                  <p className="text-xs font-bold text-blue-600 uppercase">No Le√≠das</p>
                  <p className="text-2xl font-black text-blue-700">{region.unreadAlerts}</p>
                </div>
              </div>
              
              {/* Top Alerts Preview */}
              <div className="space-y-2">
                {region.topAlerts.slice(0, 2).map(alert => (
                  <div key={alert.id} className="bg-slate-50 rounded-lg p-2">
                    <p className="text-xs font-bold text-slate-700 line-clamp-1">
                      {alert.title}
                    </p>
                    <p className="text-[10px] text-slate-500">
                      {formatDistanceToNow(new Date(alert.createdAt))}
                    </p>
                  </div>
                ))}
              </div>
              
              <Button 
                variant="ghost" 
                className="w-full rounded-xl"
                onClick={() => navigateToRegion(region.regionId)}
              >
                Ver Todas ‚Üí
              </Button>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  </CardContent>
</Card>
```

### 2. Dashboard del Coordinador - Alertas de Gestores

```typescript
// apps/web/src/app/dashboard/page.tsx (Coordinator)

<Card className="rounded-[3rem] border-none bg-white shadow-2xl">
  <CardHeader className="bg-gradient-to-r from-blue-50 to-indigo-50 p-8">
    <div className="flex items-center justify-between">
      <div>
        <Badge className="bg-blue-600 text-white mb-3">
          Mi Regi√≥n
        </Badge>
        <CardTitle className="text-3xl font-black uppercase">
          Alertas de Gestores
        </CardTitle>
        <p className="text-slate-500 font-medium mt-2">
          {currentUser.region?.name}
        </p>
      </div>
      <div className="text-right">
        <p className="text-5xl font-black text-blue-600">{managerAlerts.length}</p>
        <p className="text-xs font-bold text-slate-400 uppercase">Alertas Activas</p>
      </div>
    </div>
  </CardHeader>
  
  <CardContent className="p-8">
    {/* Filtros Inteligentes */}
    <div className="flex gap-3 mb-6">
      <Button 
        variant={filter === 'all' ? 'default' : 'outline'}
        className="rounded-2xl"
        onClick={() => setFilter('all')}
      >
        Todas ({managerAlerts.length})
      </Button>
      <Button 
        variant={filter === 'unread' ? 'default' : 'outline'}
        className="rounded-2xl"
        onClick={() => setFilter('unread')}
      >
        No Le√≠das ({unreadCount})
      </Button>
      <Button 
        variant={filter === 'critical' ? 'default' : 'outline'}
        className="rounded-2xl bg-red-600 hover:bg-red-700"
        onClick={() => setFilter('critical')}
      >
        Cr√≠ticas ({criticalCount})
      </Button>
    </div>
    
    {/* Lista de Alertas Agrupadas por Gestor */}
    <div className="space-y-6">
      {groupedByManager.map(group => (
        <div key={group.managerId} className="space-y-3">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white font-black">
              {group.managerName.charAt(0)}
            </div>
            <div>
              <h3 className="font-black text-slate-900">{group.managerName}</h3>
              <p className="text-xs text-slate-500">{group.alerts.length} alertas</p>
            </div>
          </div>
          
          <div className="grid gap-3 pl-13">
            {group.alerts.map(alert => (
              <AlertCard 
                key={alert.id} 
                alert={alert}
                onRead={() => markAsRead(alert.id)}
                onClick={() => openAlertDetail(alert)}
              />
            ))}
          </div>
        </div>
      ))}
    </div>
  </CardContent>
</Card>
```

### 3. Componente de Alerta Premium

```typescript
// apps/web/src/components/dashboard/AlertCard.tsx

interface AlertCardProps {
  alert: Alert;
  onRead: () => void;
  onClick: () => void;
}

export function AlertCard({ alert, onRead, onClick }: AlertCardProps) {
  const priorityConfig = {
    EMERGENCY: {
      bg: 'bg-red-500',
      border: 'border-red-500',
      text: 'text-red-700',
      icon: AlertTriangle,
      pulse: true
    },
    CRITICAL: {
      bg: 'bg-orange-500',
      border: 'border-orange-500',
      text: 'text-orange-700',
      icon: AlertCircle,
      pulse: false
    },
    WARNING: {
      bg: 'bg-amber-500',
      border: 'border-amber-500',
      text: 'text-amber-700',
      icon: AlertCircle,
      pulse: false
    },
    INFO: {
      bg: 'bg-blue-500',
      border: 'border-blue-500',
      text: 'text-blue-700',
      icon: Info,
      pulse: false
    }
  };

  const config = priorityConfig[alert.alertLevel];
  const Icon = config.icon;

  return (
    <Card 
      className={`rounded-2xl border-2 ${config.border} ${
        !alert.isRead ? 'bg-white shadow-lg' : 'bg-slate-50 opacity-75'
      } hover:shadow-2xl transition-all duration-300 cursor-pointer group`}
      onClick={onClick}
    >
      <CardContent className="p-4">
        <div className="flex items-start gap-4">
          {/* Icon with pulse animation for emergencies */}
          <div className={`relative flex-shrink-0`}>
            <div className={`h-12 w-12 rounded-2xl ${config.bg} flex items-center justify-center text-white`}>
              <Icon className="h-6 w-6" />
            </div>
            {config.pulse && (
              <div className={`absolute inset-0 rounded-2xl ${config.bg} animate-ping opacity-75`} />
            )}
            {!alert.isRead && (
              <div className="absolute -top-1 -right-1 h-3 w-3 rounded-full bg-blue-600 border-2 border-white" />
            )}
          </div>

          {/* Content */}
          <div className="flex-1 min-w-0">
            <div className="flex items-start justify-between gap-3 mb-2">
              <h3 className="font-black text-slate-900 group-hover:text-blue-600 transition-colors">
                {alert.title}
              </h3>
              <Badge className={`${config.bg} text-white text-[8px] font-black uppercase tracking-widest flex-shrink-0`}>
                {alert.alertLevel}
              </Badge>
            </div>

            {/* AI Summary */}
            {alert.aiSummary && (
              <p className="text-sm text-slate-600 line-clamp-2 mb-3">
                {alert.aiSummary}
              </p>
            )}

            {/* Metadata */}
            <div className="flex items-center gap-4 text-xs text-slate-500">
              <div className="flex items-center gap-1">
                <User className="h-3 w-3" />
                <span className="font-medium">{alert.user.fullName}</span>
              </div>
              <div className="flex items-center gap-1">
                <MapPin className="h-3 w-3" />
                <span>{alert.region?.name || 'Nacional'}</span>
              </div>
              <div className="flex items-center gap-1">
                <Clock className="h-3 w-3" />
                <span>{formatDistanceToNow(new Date(alert.createdAt), { addSuffix: true, locale: es })}</span>
              </div>
            </div>

            {/* AI Tags */}
            {alert.aiTags && alert.aiTags.length > 0 && (
              <div className="flex gap-2 mt-3 flex-wrap">
                {alert.aiTags.slice(0, 3).map(tag => (
                  <Badge key={tag} variant="outline" className="text-[9px] rounded-lg">
                    #{tag}
                  </Badge>
                ))}
              </div>
            )}

            {/* AI Priority Score */}
            <div className="mt-3 flex items-center gap-2">
              <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                <div 
                  className={`h-full ${config.bg} transition-all duration-500`}
                  style={{ width: `${alert.aiPriority}%` }}
                />
              </div>
              <span className="text-xs font-bold text-slate-400">
                {Math.round(alert.aiPriority)}
              </span>
            </div>
          </div>

          {/* Actions */}
          <div className="flex flex-col gap-2">
            {!alert.isRead && (
              <Button
                size="sm"
                variant="ghost"
                className="h-8 w-8 rounded-xl"
                onClick={(e) => {
                  e.stopPropagation();
                  onRead();
                }}
              >
                <Check className="h-4 w-4" />
              </Button>
            )}
            <Button
              size="sm"
              variant="ghost"
              className="h-8 w-8 rounded-xl"
            >
              <ChevronRight className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

---

## üîî Sistema de Notificaciones en Tiempo Real

### WebSocket Integration:

```typescript
// apps/api/src/alerts/alerts.gateway.ts

@WebSocketGateway({
  cors: { origin: '*' }
})
export class AlertsGateway {
  @WebSocketServer()
  server: Server;

  async notifyNewAlert(alert: RegionalReport) {
    // Calcular audiencia basada en visibilidad
    const audience = await this.calculateAudience(alert);
    
    // Enviar notificaci√≥n a cada usuario en la audiencia
    audience.forEach(userId => {
      this.server.to(`user-${userId}`).emit('new-alert', {
        id: alert.id,
        title: alert.title,
        alertLevel: alert.alertLevel,
        aiPriority: alert.aiPriority,
        createdAt: alert.createdAt
      });
    });
  }

  private async calculateAudience(alert: RegionalReport): Promise<string[]> {
    const creator = await this.prisma.user.findUnique({
      where: { id: alert.userId },
      include: { region: true, assignedRegions: true }
    });

    let audience: string[] = [];

    switch (creator.role) {
      case 'ADMIN':
        // Todos los usuarios
        const allUsers = await this.prisma.user.findMany({
          select: { id: true }
        });
        audience = allUsers.map(u => u.id);
        break;

      case 'COORDINATOR':
        // Gestores de su regi√≥n + admins
        const regionalUsers = await this.prisma.user.findMany({
          where: {
            OR: [
              { role: 'ADMIN' },
              { 
                regionId: creator.regionId,
                role: { in: ['USER', 'SUPPORT'] }
              }
            ]
          },
          select: { id: true }
        });
        audience = regionalUsers.map(u => u.id);
        break;

      case 'USER':
      case 'SUPPORT':
        // Coordinador de su regi√≥n + admins + gestores de regiones compartidas
        const managers = await this.prisma.user.findMany({
          where: {
            OR: [
              { role: 'ADMIN' },
              { 
                role: 'COORDINATOR',
                regionId: creator.regionId
              },
              {
                role: { in: ['USER', 'SUPPORT'] },
                assignedRegions: {
                  some: {
                    id: { in: creator.assignedRegions.map(r => r.id) }
                  }
                }
              }
            ]
          },
          select: { id: true }
        });
        audience = managers.map(u => u.id);
        break;
    }

    return audience;
  }
}
```

---

## üìä Analytics y M√©tricas

### Dashboard de M√©tricas de Alertas:

```typescript
interface AlertMetrics {
  // M√©tricas generales
  totalAlerts: number;
  activeAlerts: number;
  resolvedAlerts: number;
  averageResponseTime: number; // minutos
  
  // Por nivel
  emergencyCount: number;
  criticalCount: number;
  warningCount: number;
  infoCount: number;
  
  // Por regi√≥n
  regionalBreakdown: {
    regionId: string;
    regionName: string;
    count: number;
    avgPriority: number;
  }[];
  
  // Tendencias
  alertsLast7Days: number[];
  alertsLast30Days: number[];
  
  // Top creadores
  topAlertCreators: {
    userId: string;
    userName: string;
    count: number;
    avgPriority: number;
  }[];
}
```

---

## üöÄ Plan de Implementaci√≥n

### Fase 1: Backend (Semana 1)
- [ ] Extender modelo Prisma con campos de alertas
- [ ] Migraci√≥n de base de datos
- [ ] Implementar servicio de IA para scoring
- [ ] Implementar l√≥gica de visibilidad
- [ ] Crear endpoints de alertas
- [ ] Testing unitario

### Fase 2: WebSockets (Semana 2)
- [ ] Configurar WebSocket Gateway
- [ ] Implementar sistema de rooms por usuario
- [ ] Implementar notificaciones en tiempo real
- [ ] Testing de conexiones

### Fase 3: Frontend (Semana 3)
- [ ] Componente AlertCard premium
- [ ] Dashboard de Admin con monitoreo regional
- [ ] Dashboard de Coordinador con alertas de gestores
- [ ] Dashboard de Gestor con alertas relevantes
- [ ] Integraci√≥n WebSocket en frontend

### Fase 4: IA y Analytics (Semana 4)
- [ ] Implementar algoritmo de scoring completo
- [ ] An√°lisis de sentimiento
- [ ] Generaci√≥n de res√∫menes con IA
- [ ] Dashboard de m√©tricas
- [ ] Optimizaci√≥n de rendimiento

---

## ‚ú® Caracter√≠sticas Premium

1. **Priorizaci√≥n Inteligente con IA** - Score autom√°tico 0-100
2. **Visibilidad Jer√°rquica** - Filtrado autom√°tico por rol
3. **Notificaciones en Tiempo Real** - WebSockets
4. **Res√∫menes Autom√°ticos** - IA genera res√∫menes
5. **Tags Inteligentes** - Categorizaci√≥n autom√°tica
6. **Analytics Avanzados** - M√©tricas y tendencias
7. **Dise√±o Premium** - Estilo Apple/Silicon Valley
8. **Responsive** - Mobile-first design
9. **Accesibilidad** - WCAG 2.1 AA compliant
10. **Performance** - Optimizado para miles de alertas

---

**Desarrollado con üß† IA + ‚ù§Ô∏è Silicon Valley Principles**
